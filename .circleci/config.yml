machine:
  java:
    version: openjdk8
  
  environment:
    ANDROID_HOME: /usr/local/android-sdk-linux

jobs:
  build:
    dependencies:
      pre:
        - sudo update-alternatives --set java /usr/lib/jvm/jdk1.8.0/bin/java
        - sudo update-alternatives --set javac /usr/lib/jvm/java-8-openjdk-amd64/bin/javac
        - echo 'export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64' >> ~/.circlerc
        - echo y | android update sdk --no-ui --all --filter "tools"
        - echo y | android update sdk --no-ui --all --filter "platform-tools"
        - echo y | android update sdk --no-ui --all --filter "build-tools"
        - echo y | android update sdk --no-ui --all --filter "android-25"
        - echo y | android update sdk --no-ui --all --filter "extra-google-m2repository"
        - echo y | android update sdk --no-ui --all --filter "extra-google-google_play_services"
        - echo y | android update sdk --no-ui --all --filter "extra-android-support"
        - echo y | android update sdk --no-ui --all --filter "extra-android-m2repository"
   
      override:
        - ANDROID_HOME=/user/local/android-sdk-linux ./gradlew dependencies     
    
    docker:
      - image: circleci/openjdk:8-jdk

    working_directory: ~/Android

    environment:
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3200m
      TERM: dumb
    
    pre:
      - emulator -avd circleci-android24 -no-window:
        background: true
        parallel: true
      - circle-android wait-for-boot    

    steps:
      - checkout
      - run:
          name: install-script
          command: './install.sh'      

      # Download and cache dependencies
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "build.gradle" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-

      - run: 
          name: tests
          command: './gradlew cAT'

      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "build.gradle" }}    
