aliases:
  - &setup-env
    name: Setup Envionrment
    shell: /bin/bash
    command: source .circleci/ci-helper.sh && envSetup

  - &determine-tests-to-run
    name: Determine Tests to Run
    shell: /bin/bash
    command: source .circleci/ci-helper.sh && printTestsToRun

  - &run-danger
    name:  Run Danger
    when: always
    command:  source .circleci/ci-helper.sh && runDanger

  - &launch-emulator
    name:  Launch Emulator
    command: source .circleci/ci-helper.sh && startAVD
    background: true

  - &wait-for-emulator
    name:  Wait for Emulator to boot
    command: source .circleci/ci-helper.sh && waitForAVD

  - &run-unit-tests
    halt_build_on_fail: false
    no_output_timeout: 900
    command: source .circleci/ci-helper.sh && runTests

  - &android-lint
    name: Run Android Lint
    command:  ./gradlew lint
    when: always

  - &capture-logcat
    name: Capture Logcat
    command: adb logcat *:v > logcat.txt
    background: true

  - &gradle-cache-key
    gradle-cache-v2-{{ checksum "build.gradle" }}-{{
      checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{
      checksum "libs/SalesforceAnalytics/build.gradle" }}-{{
      checksum "libs/SalesforceSDK/build.gradle" }}-{{
      checksum "libs/SmartStore/build.gradle" }}-{{
      checksum "libs/SmartSync/build.gradle" }}-{{
      checksum "libs/SalesforceHybrid/build.gradle" }}-{{
      checksum "libs/SalesforceReact/build.gradle" }}

  - &restore-gradle-cache
    keys:
      - *gradle-cache-key

  - &restore-node-cache
    keys:
      - node-cache-{{ checksum "package.json" }}

  - &restore-ruby-cache
    keys:
      - ruby-gem-cache-{{ .BuildNum }}
      - ruby-gem-cache-

  - &save-gradle-cache
    key: *gradle-cache-key
    paths:
      - .gradle
      - /home/circleci/.gradle

  - &save-node-cache
    key: node-cache-{{ checksum "package.json" }}
    paths:
      - node_modules

  - &save-ruby-cache
    key: ruby-gem-cache-{{ .BuildNum }}
    paths:
      - /home/circleci/.rubies

  - &codecov
    name: Codecov
    command: bash <(curl -s https://codecov.io/bash)
    when: always

  - &store-gcloud-account
    name: Store Google Service Account
    command: echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json 

  - &gcloud-auth
    name: Authorize gcloud and set config defaults
    command: |
        gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
        gcloud --quiet config set project mobile-apps-firebase-test 

  - &get-firebase-results
    name: Copy test results data
    command: |
        mkdir -p firebase/results
        gsutil -m cp -r -U "`gsutil ls gs://test-lab-${CURRENT_LIB}-${CIRCLE_BUILD_NUM}M} | tail -1`*" ./firebase/
        mv firebase/**/test_result_1.xml firebase/results
    when: always
    
  - &run-firebase-tests
    name: Test
    command: |

        gcloud firebase test android run \
            --project mobile-apps-firebase-test \
            --type instrumentation \
            --app ${TEST_APP_APK} \
            --test ${TEST_APK}  \
            --device model=NexusLowRes,version=26,locale=en,orientation=portrait  \
            --environment-variables coverage=true,coverageFile=/sdcard/tmp/code-coverage/connected/coverage.ec  \
            --directories-to-pull=/sdcard/tmp  \
            --results-dir=${CURRENT_LIB}-${CIRCLE_BUILD_NUM}
            --results-history-name=${CURRENT_LIB}
            --timeout 15m
    no_output_timeout: 900

  - &attach_workspace
    attach_workspace:
      at: ~/SalesforceMobileSDK-Android

defaults: &defaults
  working_directory: ~/SalesforceMobileSDK-Android
  docker:
    - image: circleci/android:api-28-node8-alpha
  environment:
    - TERM: "dumb"
    - ADB_INSTALL_TIMEOUT: 15
    - _JAVA_OPTIONS: "-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"
    - GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-XX:+HeapDumpOnOutOfMemoryError"'
    - ANDROID_NDK: '/opt/ndk/android-ndk-r10e'
    - BUILD_THREADS: 2


#########################
#                       #
#        PR Jobs        #
#                       #
#########################

version: 2
jobs:
  setup:
    <<: *defaults
    steps:
      - checkout
      - run: *determine-tests-to-run
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-node-cache
      - restore_cache: *restore-ruby-cache
      - run: *setup-env
      - run: *android-lint
      - save_cache: *save-gradle-cache
      - save_cache: *save-node-cache
      - save_cache: *save-ruby-cache
      - run: *run-danger
      - persist_to_workspace:
          root: .
          paths:
            - ./**

  firebase-setup:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-node-cache
      - restore_cache: *restore-ruby-cache
      - run: *setup-env
      - run:
          name: Build for Testing
          command: ./gradlew assembleAndroidtest
      - persist_to_workspace:
          root: .
          paths:
            - ./**

  test-SalesforceAnalytics:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SalesforceAnalytics"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: libs/SalesforceAnalytics/build/reports/
          destination: SalesforceAnalytics
      - store_test_results:
          path: libs/SalesforceAnalytics/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: SalesforceAnalytics
      - run: *run-danger
      - run: *codecov

  test-SalesforceAnalytics-firebase:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SalesforceAnalytics"
      - TEST_APK: "libs/SalesforceAnalytics/build/outputs/apk/androidTest/debug/SalesforceAnalytics-debug-androidTest.apk"
      - TEST_APP_APK: "native/NativeSampleApps/AppConfigurator/build/outputs/apk/androidTest/debug/AppConfigurator-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |
      #      ./gradlew :libs:SalesforceAnalytics:assembleAndroidtest
      #      ./gradlew native:NativeSampleApps:AppConfigurator:assembleAndroidTest
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results  

  test-SalesforceSDK:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SalesforceSDK"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: libs/SalesforceSDK/build/reports/
          destination: SalesforceSDK
      - store_test_results:
          path: libs/SalesforceSDK/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: SalesforceSDK
      - run: *run-danger
      - run: *codecov

  test-SalesforceSDK-firebase:
    <<: *defaults
    environment:
      - TEST_APK: "libs/SalesforceSDK/build/outputs/apk/androidTest/debug/SalesforceSDK-debug-androidTest.apk"
      - TEST_APP_APK: "native/NativeSampleApps/AppConfigurator/build/outputs/apk/androidTest/debug/AppConfigurator-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |
      #      ./gradlew :libs:SalesforceSDK:assembleAndroidtest
      #      ./gradlew native:NativeSampleApps:AppConfigurator:assembleAndroidTest
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results

  test-SmartStore:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SmartStore"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: libs/SmartStore/build/reports/
          destination: SmartStore
      - store_test_results:
          path: libs/SmartStore/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: SmartStore
      - run: *run-danger
      - run: *codecov

  test-SmartStore-firebase:
    <<: *defaults
    environment:
      - TEST_APK: "libs/SmartStore/build/outputs/apk/androidTest/debug/SmartStore-debug-androidTest.apk"
      - TEST_APP_APK: "native/NativeSampleApps/SmartSyncExplorer/build/outputs/apk/androidTest/debug/SmartSyncExplorer-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |
      #      ./gradlew :libs:SmartStore:assembleAndroidtest
      #      ./gradlew native:NativeSampleApps:SmartSyncExplorer:assembleAndroidTest
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results

  test-SmartSync:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SmartSync"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: libs/SmartSync/build/reports/
          destination: SmartSync
      - store_test_results:
          path: libs/SmartSync/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: SmartSync
      - run: *run-danger
      - run: *codecov

  test-SmartSync-firebase:
    <<: *defaults
    environment:
      - TEST_APK: "libs/SmartSync/build/outputs/apk/androidTest/debug/SmartSync-debug-androidTest.apk"
      - TEST_APP_APK: "native/NativeSampleApps/SmartSyncExplorer/build/outputs/apk/androidTest/debug/SmartSyncExplorer-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |
      #      ./gradlew :libs:SmartSync:assembleAndroidtest
      #      ./gradlew native:NativeSampleApps:SmartSyncExplorer:assembleAndroidTest
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results  

  test-SalesforceHybrid:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SalesforceHybrid"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: libs/SalesforceHybrid/build/reports/
          destination: SalesforceHybrid
      - store_test_results:
          path: libs/SalesforceHybrid/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: SalesforceHybrid
      - run: *run-danger
      - run: *codecov

  test-SalesforceHybrid-firebase:
    <<: *defaults
    environment:
      - TEST_APK: "./hybrid/HybridSampleApps/SmartSyncExplorerHybrid/build/outputs/apk/androidTest/debug/SmartSyncExplorerHybrid-debug-androidTest.apk"
      - TEST_APP_APK: "./libs/SalesforceHybrid/build/outputs/apk/androidTest/debug/SalesforceHybrid-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |
      #      ./gradlew :libs:SalesforceHybrid:assembleAndroidtest
      #      ./gradlew :hybrid:HybridSampleApps:SmartSyncExplorerHybrid:assembleAndroidTest
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
          path: firebase/
      - store_test_results:
          path: firebase/results  

  test-RestExplorer:
    <<: *defaults
    environment:
      - CURRENT_LIB: "RestExplorer"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: native/NativeSampleApps/RestExplorer/build/reports/
          destination: RestExplorer
      - store_test_results:
          path: native/NativeSampleApps/RestExplorer/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: RestExplorer
      - run: *run-danger
      - run: *codecov
      
  test-RestExplorer-firebase:
    <<: *defaults
    environment:
      - TEST_APK: "native/NativeSampleApps/RestExplorer/build/outputs/apk/androidTest/debug/RestExplorer-debug-androidTest.apk"
      - TEST_APP_APK: "./libs/SalesforceHybrid/build/outputs/apk/androidTest/debug/SalesforceHybrid-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |      
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results

  test-SalesforceReact:
    <<: *defaults
    environment:
      - CURRENT_LIB: "SalesforceReact"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      - run: *determine-tests-to-run
      - run: *launch-emulator
      - run: *wait-for-emulator
      - run: *capture-logcat
      - run: *run-unit-tests
      - save_cache: *save-gradle-cache
      - store_artifacts:
          path: libs/SalesforceReact/build/reports/
          destination: SalesforceReact
      - store_test_results:
          path: libs/SalesforceReact/build/outputs/androidTest-results/
      - store_artifacts:
          path: logcat.txt
          destination: SalesforceReact
      - run: *run-danger
      - run: *codecov

  test-SalesforceReact-firebase:
    <<: *defaults
    environment:
      - TEST_APK: "libs/SalesforceReact/build/outputs/apk/androidTest/debug/SalesforceReact-debug-androidTest.apk"
      - TEST_APP_APK: "./libs/SalesforceHybrid/build/outputs/apk/androidTest/debug/SalesforceHybrid-debug-androidTest.apk"
    steps:
      - *attach_workspace
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-ruby-cache
      #- run:
      #    name: Build for Testing
      #    command:  |
      #      ./gradlew libs:SalesforceReact:assembleAndroidTest
      - run: *store-gcloud-account
      - run: *gcloud-auth
      - run: *run-firebase-tests
      - run: *get-firebase-results
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results


##########################
#                        #
#      Nightly Jobs      #
#                        #
##########################

  generate-artifacts:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-node-cache
      - run: *setup-env
      - save_cache: *save-node-cache
      - run: 
          name: Build Libraries
          command:  |
            ./gradlew :libs:SalesforceAnalytics:assemble
            ./gradlew :libs:SalesforceSDK:assemble
            ./gradlew :libs:SmartStore:assemble
            ./gradlew :libs:SmartSync:assemble
            ./gradlew :libs:SalesforceHybrid:assemble
            ./gradlew :libs:SalesforceReact:assemble
          when: always
      - store_artifacts:
          path: libs/SalesforceAnalytics/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SalesforceSDK/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SmartStore/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SmartSync/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SalesforceHybrid/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SalesforceReact/build/outputs/aar/
          destination: libraries
      - run:
          name: Build Native Sample Apps
          when: always
          command:  |
            ./gradlew :native:NativeSampleApps:AppConfigurator:assemble
            ./gradlew :native:NativeSampleApps:ConfiguredApp:assemble
            ./gradlew :native:NativeSampleApps:RestExplorer:assemble
            ./gradlew :native:NativeSampleApps:SmartSyncExplorer:assemble
      - store_artifacts:
          path: native/NativeSampleApps/AppConfigurator/build/outputs/apk/
          destination: native-apps
      - store_artifacts:
          path: native/NativeSampleApps/ConfiguredApp/build/outputs/apk/
          destination: native-apps
      - store_artifacts:
          path: native/NativeSampleApps/RestExplorer/build/outputs/apk/
          destination: native-apps
      - store_artifacts:
          path: native/NativeSampleApps/SmartSyncExplorer/build/outputs/apk/
          destination: native-apps
      - run:
          name: Build Hybrid Sample Apps
          when: always
          command:  |
            ./gradlew :hybrid:HybridSampleApps:AccountEditor:assemble
            ./gradlew :hybrid:HybridSampleApps:NoteSync:assemble
            ./gradlew :hybrid:HybridSampleApps:SmartSyncExplorerHybrid:assemble
      - store_artifacts:
          path: hybrid/HybridSampleApps/AccountEditor/build/outputs/apk/
          destination: hybrid-apps
      - store_artifacts:
          path: hybrid/HybridSampleApps/NoteSync/build/outputs/apk/
          destination: hybrid-apps
      - store_artifacts:
          path: hybrid/HybridSampleApps/SmartSyncExplorerHybrid/build/outputs/apk/
          destination: hybrid-apps
      - save_cache: *save-gradle-cache


#####################
#                   #
#     Workflows     #
#                   #
#####################

workflows:
  version: 2

  nightly-test:
     jobs:
        - firebase-setup
        - test-SalesforceAnalytics-firebase:
            requires:
                - firebase-setup
        #- test-SalesforceSDK-firebase:
        #    requires:
        #        - firebase-setup
        #- test-SmartStore-firebase:
        #    requires:
        #        - firebase-setup
        #- test-SmartSync-firebase:
        #    requires:
        #        - firebase-setup
        #- test-SalesforceHybrid-firebase:
        #    requires:
        #        - firebase-setup
        #- test-SalesforceReact-firebase:
        #    requires:
        #        - firebase-setup
        #- test-RestExplorer-firebase:
        #    requires:
        #        - firebase-setup